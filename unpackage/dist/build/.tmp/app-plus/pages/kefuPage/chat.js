(global["webpackJsonp"]=global["webpackJsonp"]||[]).push([["pages/kefuPage/chat"],{2044:function(e,t,n){},"5a8d":function(e,t,n){"use strict";(function(e){n("42eb"),n("921b");a(n("66fd"));var t=a(n("809d"));function a(e){return e&&e.__esModule?e:{default:e}}e(t.default)}).call(this,n("6e42")["createPage"])},"809d":function(e,t,n){"use strict";n.r(t);var a=n("a443"),o=n("abf2");for(var i in o)"default"!==i&&function(e){n.d(t,e,function(){return o[e]})}(i);n("8497");var r,s=n("f0c5"),c=Object(s["a"])(o["default"],a["b"],a["c"],!1,null,null,null,!1,a["a"],r);t["default"]=c.exports},8497:function(e,t,n){"use strict";var a=n("2044"),o=n.n(a);o.a},a443:function(e,t,n){"use strict";var a,o=function(){var e=this,t=e.$createElement;e._self._c},i=[];n.d(t,"b",function(){return o}),n.d(t,"c",function(){return i}),n.d(t,"a",function(){return a})},abf2:function(e,t,n){"use strict";n.r(t);var a=n("e822"),o=n.n(a);for(var i in a)"default"!==i&&function(e){n.d(t,e,function(){return a[e]})}(i);t["default"]=o.a},e822:function(e,t,n){"use strict";(function(e,a){Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var o=i(n("a34a"));function i(e){return e&&e.__esModule?e:{default:e}}function r(e){return u(e)||c(e)||s()}function s(){throw new TypeError("Invalid attempt to spread non-iterable instance")}function c(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}function u(e){if(Array.isArray(e)){for(var t=0,n=new Array(e.length);t<e.length;t++)n[t]=e[t];return n}}function h(e,t,n,a,o,i,r){try{var s=e[i](r),c=s.value}catch(u){return void n(u)}s.done?t(c):Promise.resolve(c).then(a,o)}function g(e){return function(){var t=this,n=arguments;return new Promise(function(a,o){var i=e.apply(t,n);function r(e){h(i,a,o,r,s,"next",e)}function s(e){h(i,a,o,r,s,"throw",e)}r(void 0)})}}var l=function(){return n.e("components/badge/badge").then(n.bind(null,"4892"))},m=function(){return n.e("components/loadmore/loadmore").then(n.bind(null,"6b7e"))},f=function(){return n.e("components/chatInput").then(n.bind(null,"e515"))},d=n("e985"),p=n("44dd"),y=n("9e98"),v="",b=!1,M={components:{tuiBadge:l,tuiLoadmore:m,chatInput:f},data:function(){return{loadding:!1,show:!1,bottom:0,scrollTop:0,scrollInoViewID:"",style:{pageHeight:0,contentViewHeight:0,footViewHeight:90,mitemHeight:0},chatMsg:[],mathNumber:Math.floor(5*Math.random()+10),pageNo:1,pageSize:15,total:0,historyMsgList:[],username:{yourName:"",myName:""},chatUserInfo:{avatar:"",nickname:""},visibility:!1,myPhoto:"",shopPhoto:"",shopName:"",shopPhoto1:"",paintImg:"",msgNumbers:-10}},beforeMount:function(){this.visibility=!0,0,0},beforeDestroy:function(){this.visibility=!1},onLoad:function(t){e("log",t," at pages\\kefuPage\\chat.vue:144");var n=a.getSystemInfoSync();this.style.pageHeight=n.windowHeight,this.style.contentViewHeight=n.windowHeight-n.screenWidth/750*114;var o=JSON.parse(t.username);e("log",o," at pages\\kefuPage\\chat.vue:150"),this.myPhoto=this.$store.state.userInfo.photo,this.paintImg=o.userImg,a.setNavigationBarTitle({title:o.paintName}),this.username={yourName:o.yourName,myName:a.getStorageSync("myUsername")};a.getStorageSync("changePhoto");e("log",getApp().globalData.memberList," at pages\\kefuPage\\chat.vue:176"),e("log",this.chatMsg," at pages\\kefuPage\\chat.vue:190")},onUnload:function(){p.fire("em.chatroom.leave")},created:function(){},onShow:function(){e("log",this.chatMsg," at pages\\kefuPage\\chat.vue:203")},onReady:function(){this.create_or_onready()},methods:{previewImage:function(e){e=[e],a.previewImage({urls:e})},create_or_onready:function(){var t=this,n=t.username,o=a.getStorageSync("myUsername"),i=n.yourName+o,r=a.getStorageSync(i)||[];t.renderMsg(null,null,r,i),a.setStorageSync(i,null),p.on("em.xmpp.error.sendMsgErr",function(e){v=e.data.mid,b=!0}),d.on("newChatMsg",function(a,o,r,s){t.visibility&&(a.info.from!=n.yourName&&a.info.to!=n.yourName||(e("log","判断是否属于当前会话",s,i," at pages\\kefuPage\\chat.vue:244"),s==i&&t.renderMsg(a,o,r,i,"newMsg")))})},renderMsg:function(t,n,o,i,r){o.length>1&&(e("log","判断消息列表中的消息是否重复",this.chatMsg," at pages\\kefuPage\\chat.vue:257"),this.chatMsg.map(function(e,t){o.map(function(t,n){e.mid==t.mid&&o.splice(n,1)})}));var s=a.getStorageSync("rendered_"+i)||[];if(s=s.concat(o),s.length){"newMsg"==r?(this.chatMsg=this.chatMsg.concat(o),this.scrollInoViewID=o[0].mid):(this.chatMsg=s.slice(this.msgNumbers),this.scrollInoViewID=s[s.length-1].mid),a.setStorageSync("rendered_"+i,s.slice(-2e6));var c=a.getStorageSync(i)||[];c.map(function(e,t){o.map(function(n,a){n.mid==e.mid&&c.splice(t,1)})}),a.setStorageSync(i,c),s.slice(-1e6).length,a.pageScrollTo({scrollTop:9999}),b&&this.renderFail(i)}},renderFail:function(e){var t=this,n=t.chatMsg;n.map(function(e){e.mid.substring(e.mid.length-10)==v.substring(v.length-10)&&(e.msg.data[0].isFail=!0,e.isFail=!0,t.chatMsg=n)}),t.curChatMsg[0].mid==v&&(t.curChatMsg[0].msg.data[0].isShow=!1,t.curChatMsg[0].isShow=!1),a.setStorageSync("rendered_"+e,n.slice(-20)),b=!1},replySubmit:function(t){if(String.prototype.trim=function(){return this.replace(/(^\s*)|(\s*$)/g,"")},t.trim()){var n=this.$im.conn.getUniqueId(),o=new this.$im.message(y.TEXT,n);o.set({msg:t,from:this.username.myName,to:this.username.yourName,ext:{fromName:a.getStorageSync("myUsername"),myName:this.$store.state.userInfo.nickname,fromAvatar:this.$store.state.userInfo.avatar,hxMsgId:y.TEXT+n,toHxName:this.username.yourName,toName:this.shopName,toImg:this.shopPhoto1},roomType:!1,chatType:this.chatType,success:function(n,a){e("log","消息发送成功"," at pages\\kefuPage\\chat.vue:355"),p.fire("em.chat.sendSuccess",n,t)},fail:function(t,n){e("log","消息发送失败"," at pages\\kefuPage\\chat.vue:359")}});try{this.$im.conn.send(o.body)}catch(r){e("log",r," at pages\\kefuPage\\chat.vue:365")}var i={msg:o,type:y.TEXT};d.saveMsg(i.msg,i.type),this.zhuanfa(t)}},zhuanfa:function(e){var t={d_phone:this.username.myName,hid:this.username.yourName,content:e,d_nickname:this.$store.state.userInfo.nickName};this.$http.zhuanfaMessage(t).then(function(e){})},blurClearReplyInfo:function(e){},scrollToupper:function(){var e=g(o.default.mark(function e(t){var n,a,i;return o.default.wrap(function(e){while(1)switch(e.prev=e.next){case 0:if(this.create_or_onready(),this.msgNumbers=-1e8,!t.detail.direction||this.loadding){e.next=17;break}if(this.loadding=!0,!(this.total>this.chatMsg.length)){e.next=16;break}return this.pageNo++,e.next=8,this.$http.queryHistoryMessage(this.username.yourName.toString(),this.pageNo,this.pageSize);case 8:n=e.sent,a=n.data.records.reverse(),i=[].concat(r(a),r(this.chatMsg)),this.chatMsg=i,this.scrollInoViewID=this.chatMsg[n.data.records.length].hxMsgId||this.chatMsg[n.data.records.length].mid,this.loadding=!1,e.next=17;break;case 16:this.loadding=!1;case 17:case"end":return e.stop()}},e,this)}));function t(t){return e.apply(this,arguments)}return t}()}};t.default=M}).call(this,n("0de9")["default"],n("6e42")["default"])}},[["5a8d","common/runtime","common/vendor"]]]);